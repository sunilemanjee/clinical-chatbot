<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talking Avatar Chat Demo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='image/favicon.ico') }}">
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js"></script>
</head>
<body>
<h1>Talking Avatar Chat Demo</h1>

<input type="hidden" id="clientId" value="{{ client_id }}"></input>
<input type="hidden" id="enableWebSockets" value="{{ enable_websockets }}"></input>

<div id="configuration">
  <h2 style="background-color: white; width: 300px;">Chat Configuration</h2>
  <label style="font-size: medium;" for="azureOpenAIDeploymentName">Azure OpenAI Deployment Name:</label>
  <input id="azureOpenAIDeploymentName" type="text" size="32" style="font-size: medium;" /><br />
  <label style="font-size: medium;"  for="prompt">System Prompt:</label><br/>
  <textarea id="prompt" style="max-width: 640px;" placeholder="Loading system prompt..."></textarea>
  <div style="background-color: white; width: 300px;">
    <input type="checkbox" id="enableOyd" onchange="window.updataEnableOyd()">Enable On Your Data</input><br />
  </div>
  <br />

  <div id="cogSearchConfig" hidden="hidden">
    <label style="font-size: medium;" for="azureCogSearchIndexName">Azure Cognitive Search Index Name:</label>
    <input id="azureCogSearchIndexName" type="text" size="32" style="font-size: medium;" /><br />
    <br />
  </div>

  <h2 style="background-color: white; width: 300px;">Speech Configuration</h2>
  <label style="font-size: medium;" for="sttLocale">STT Locale(s):</label>
  <input id="sttLocales" type="text" size="64" style="font-size: medium;" value="en-US"></input><br />
  <label style="font-size: medium;" for="ttsVoice">TTS Voice:</label>
  <input id="ttsVoice" type="text" size="32" style="font-size: medium;" value="en-US-AmandaMultilingualNeural"></input><br />
  <label style="font-size: medium;" for="customVoiceEndpointId">Custom Voice Deployment ID (Endpoint ID):</label>
  <input id="customVoiceEndpointId" type="text" size="32" style="font-size: medium;" value=""></input><br />
  <label style="font-size: medium;" for="personalVoiceSpeakerProfileID">Personal Voice Speaker Profile ID:</label>
  <input id="personalVoiceSpeakerProfileID" type="text" size="32" style="font-size: medium;" value=""></input><br />
  <div style="background-color: white; width: 300px;">
    <input type="checkbox" id="continuousConversation" checked>Continuous Conversation</input><br />
  </div>
  <br />

  <h2 style="background-color: white; width: 300px;">Avatar Configuration</h2>
  <label style="font-size: medium;" for="talkingAvatarCharacter">Avatar Character:</label>
  <input id="talkingAvatarCharacter" type="text" size="16" style="font-size: medium;" value="lori"></input><br />
  <label style="font-size: medium;" for="talkingAvatarStyle">Avatar Style:</label>
  <input id="talkingAvatarStyle" type="text" size="16" style="font-size: medium;" value="graceful"></input><br />
  <div style="background-color: white; width: 200px;">
    <input type="checkbox" id="customizedAvatar">Custom Avatar</input><br />
  </div>
  <div style="background-color: white; width: 200px;">
    <input type="checkbox" id="autoReconnectAvatar">Auto Reconnect</input><br />
  </div>
  <div style="background-color: white; width: 200px;">
    <input type="checkbox" id="useLocalVideoForIdle" onchange="window.updateLocalVideoForIdle()">Use Local Video for Idle</input><br />
  </div>
  <br />
</div>

<button id="startSession" onclick="window.startSession()">Open Avatar Session</button>
<button id="microphone" onclick="window.microphone()" disabled>Start Microphone</button>
<button id="stopSpeaking" onclick="stopSpeaking()" disabled>Stop Speaking</button>
<button id="clearChatHistory" onclick="window.clearChatHistory()">Clear Chat History</button>
<button id="loadData" onclick="window.loadData()">Load Data</button>
<button id="stopSession" onclick="window.stopSession()" disabled>Close Avatar Session</button>

<div id="videoContainer" style="position: relative; max-width: 960px;">
  <div id="overlayArea" style="position: absolute;">
    <textarea id="chatHistory" style="
        border: none;
        resize: none;
        background-color: transparent;
        overflow: hidden;" hidden></textarea>
  </div>
  <div id="overlayArea" style="position: absolute; left: 68%">
    <textarea id="latencyLog" style="
        border: none;
        resize: none;
        background-color: transparent;
        overflow: hidden;" hidden></textarea>
  </div>
  <div id="localVideo" hidden>
    <video autoplay loop muted onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
      <source src="{{ url_for('static', filename='video/lisa-casual-sitting-idle.mp4') }}" type="video/mp4">
      <!-- Fallback if video is not available -->
      <div style="display:none; width: 960px; height: 540px; background-color: #f0f0f0; align-items: center; justify-content: center; color: #666;">
        <p>Avatar video not available</p>
      </div>
    </video>
  </div>
  <div id="remoteVideo"></div>
</div>

<div id="showTypeMessageCheckbox">
  <input type="checkbox" id="showTypeMessage" onchange="window.updateTypeMessageBox()" disabled>Type Message</input><br />
</div>
<textarea id="userMessageBox" style="max-width: 960px; height: 40px" hidden></textarea><br/>

<script>
// Load system prompt from prompt.md file when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadSystemPrompt();
});

function loadSystemPrompt() {
    fetch('/api/getSystemPrompt')
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to load system prompt: ${response.status} ${response.statusText}`);
            }
            return response.text();
        })
        .then(promptContent => {
            document.getElementById('prompt').value = promptContent;
        })
        .catch(error => {
            console.error('Error loading system prompt:', error);
            document.getElementById('prompt').value = 'Error loading system prompt. Please check the server logs.';
        });
}
</script>

</body>
</html>
